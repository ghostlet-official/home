<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Ghostlet — Chat</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://bjgxufxgpgojkwqbdyqp.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZ3h1ZnhncGdvamt3cWJkeXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTk1NjMsImV4cCI6MjA3ODk3NTU2M30.BRyjh8E2WK1KTquDhzfBtAmcBuxhZ4jRsZQgN_5s9rg";
  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
</script>

<style>
  html,body{margin:0;padding:0;overflow-x:hidden;background:#050505;color:#fff;font-family:Segoe UI,Arial}
  .topbar{width:100%;background:#070707;padding:12px 20px;border-bottom:3px solid #00fef0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .topbar-left{color:#00fef0;font-weight:800;font-size:20px}
  .topbar-right{display:flex;gap:12px;flex-wrap:wrap}
  .page-container{max-width:1100px;margin:24px auto;padding:20px;width:calc(100% - 40px)}
  .chat-box{background:#0e0e0e;padding:16px;border-radius:12px;height:60vh;overflow:auto}
  .message{padding:8px;border-radius:8px;margin-bottom:8px;background:#111}
  .me{background:linear-gradient(90deg,#00fef0,#8ff);color:#000}
  .msg-head{font-weight:700;color:#00fef0}
  .input-row{display:flex;gap:8px;margin-top:12px}
  input[type="text"]{flex:1;padding:10px;border-radius:8px;border:none;background:#222;color:#fff}
  button{background:#00fef0;color:#000;padding:8px 12px;border:none;border-radius:8px;cursor:pointer}
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-left">Ghostlet</div>
    <div class="topbar-right" id="navLinks"></div>
  </div>

  <div class="page-container">
    <h1 style="color:#00fef0">Chat</h1>
    <div id="chatBox" class="chat-box"></div>

    <div class="input-row">
      <input id="msgInput" placeholder="Say something..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

<script>
  const chatBox = document.getElementById('chatBox'), msgInput = document.getElementById('msgInput'), sendBtn = document.getElementById('sendBtn');

  async function setup(){
    const nav = document.getElementById('navLinks');
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) { location.href = 'login.html'; return; }
    nav.innerHTML = `<a href="index.html">Home</a><a href="market.html">Market</a><a href="blooks.html">Blooks</a><a href="stats.html">Stats</a><a href="#" id="logout">Logout</a>`;
    document.getElementById('logout').onclick = async ()=>{ await supabase.auth.signOut(); location.href='login.html' };

    // load recent messages
    await loadMessages();

    // Realtime subscription if enabled
    try {
      const channel = supabase.channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          appendMessage(payload.new);
        }).subscribe();
    } catch(e) { console.warn('Realtime not available', e); }

    // send
    sendBtn.onclick = handleSend;
    msgInput.addEventListener('keypress', e=>{ if (e.key==='Enter') handleSend(); });
  }

  async function loadMessages(){
    const { data } = await supabase.from('messages').select('*').order('sent_at',{ascending:true}).limit(500);
    chatBox.innerHTML = '';
    data.forEach(m => appendMessage(m));
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function appendMessage(m){
    const div = document.createElement('div'); div.className = 'message';
    const username = m.username || 'Unknown';
    div.innerHTML = `<div class="msg-head">${escapeHtml(username)} <span style="color:#aaa;font-weight:400;font-size:12px">• ${new Date(m.sent_at).toLocaleString()}</span></div><div style="margin-top:6px">${renderText(m.content)}</div>`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function renderText(t){ return escapeHtml(t).replace(/\n/g,'<br>'); }

  async function handleSend(){
    const txt = msgInput.value.trim(); if (!txt) return;
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return location.href='login.html';
    const uid = session.user.id;
    const username = (await supabase.from('profiles').select('username').eq('id', uid).single()).data?.username || session.user.email || 'Ghostlet';

    // insert message
    await supabase.from('messages').insert([{ user_id: uid, username, content: txt }]);

    // increment messages_sent
    const { data: profile } = await supabase.from('profiles').select('messages_sent').eq('id', uid).single();
    const messagesSent = (profile?.messages_sent || 0) + 1;
    await supabase.from('profiles').update({ messages_sent: messagesSent }).eq('id', uid);

    msgInput.value = '';
  }

  setup();
</script>
</body>
</html>
